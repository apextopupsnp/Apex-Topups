<!doctype html>
<html lang="en">
<head>
  <!--
    Apex Topups - Payment Page (QR)
    File: payment.html

    Description:
      - Shows payment instructions and QR codes for eSewa (ID: 9767438638) and optional Khalti.
      - Reads selected product from localStorage key "apex_selected_product".
      - Creates a pending order (localStorage key "apex_pending_order" and appended to "apex_orders" when user confirms/upload).
      - Provides copy-to-clipboard for eSewa ID, and "I've paid — Upload screenshot" flow that navigates to upload.html.
      - Mobile-first, dark theme with orange highlights, card-based layout.
      - Dynamically injects footer.html into #footer-container (graceful fallback included).
      - Comments included for important sections.
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment — Apex Topups</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#0b0f12" />

  <style>
    :root{
      --accent:#ff7a18;
      --muted:#98a0a6;
      --bg:#071014;
      --card:#0b1620;
      --glass: rgba(255,255,255,0.02);
      --radius:14px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071014 0%, #071418 60%);color:#e6eef2;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;-webkit-font-smoothing:antialiased;}
    .wrap{max-width:980px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:14px;min-height:100vh;}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#ff9b43);display:grid;place-items:center;font-weight:800;color:#081018;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.02);}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start;}
    .qr-box{display:flex;flex-direction:column;gap:12px;align-items:center;}
    .qr{width:260px;height:260px;border-radius:12px;padding:12px;background:#fff;display:grid;place-items:center;}
    .qr img{width:100%;height:100%;object-fit:contain;border-radius:8px;}
    .muted{color:var(--muted);font-size:13px;}
    .price{font-size:20px;font-weight:800;color:var(--accent);}
    .btn{background:var(--accent);color:#081018;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px;border-radius:10px;}
    .small{font-size:13px;color:var(--muted);}
    .info-row{display:flex;justify-content:space-between;align-items:center;gap:8px;}
    .kbd{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-weight:700;color:var(--muted);}
    .note{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;margin-top:8px;}
    @media (max-width:920px){ .grid{grid-template-columns:1fr;} .qr{width:200px;height:200px;} }
    @media (max-width:480px){ .qr{width:180px;height:180px;} .card{padding:12px;} }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">AT</div>
        <div>
          <div style="font-weight:800">Complete your payment</div>
          <div style="font-size:13px;color:var(--muted);">Scan the QR or pay using eSewa / Khalti</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn-ghost" id="btn-back">← Back to store</button>
        <button class="btn" id="btn-upload">I've paid — Upload screenshot</button>
      </div>
    </div>

    <section class="card">
      <div class="grid">
        <!-- Left: Payment instructions and QR -->
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div class="small muted">Product</div>
              <div id="product-name" style="font-weight:800">Loading…</div>
            </div>
            <div style="text-align:right;">
              <div class="small muted">Amount</div>
              <div id="product-price" class="price">₨0</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="small muted">Pay using eSewa (recommended)</div>
            <div class="qr-box" style="margin-top:8px;">
              <!-- QR is an SVG data URL embedded to ensure offline/demo availability.
                   The eSewa account ID is shown clearly: 9767438638 (as requested).
                   In a production environment this would be a genuine QR image generated by payment provider. -->
              <div class="qr" id="esewa-qr" role="img" aria-label="eSewa QR code">
                <!-- SVG inserted by JavaScript -->
              </div>

              <div style="display:flex;gap:8px;align-items:center;">
                <div class="muted">eSewa ID:</div>
                <div class="kbd" id="esewa-id">9767438638</div>
                <button class="btn-ghost" id="copy-esewa">Copy</button>
                <button class="btn-ghost" id="open-esewa">Open eSewa</button>
              </div>

              <div class="note small muted">
                Preferred payment method: eSewa. Scan the QR with your eSewa app or enter ID and amount manually.
                After payment, tap "I've paid — Upload screenshot" to attach proof and complete the order.
              </div>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:14px 0;">

          <div>
            <div class="small muted">Alternative: Khalti QR</div>
            <div class="qr-box" style="margin-top:8px;">
              <div class="qr" id="khalti-qr" role="img" aria-label="Khalti QR code">
                <!-- SVG inserted by JavaScript -->
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <div class="muted">Khalti</div>
                <button class="btn-ghost" id="copy-khalti">Copy</button>
                <button class="btn-ghost" id="open-khalti">Open Khalti</button>
              </div>
              <div class="note small muted">Khalti option is optional. Use whichever wallet you prefer. This is a frontend demo — transaction processing happens inside your wallet app.</div>
            </div>
          </div>
        </div>

        <!-- Right: Order summary & instructions -->
        <aside>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div class="small muted">Order ID</div>
              <div id="order-id" class="small">—</div>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div class="small muted">Expiry</div>
              <div id="expiry" class="small">15:00</div>
            </div>

            <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.015);">
              <div class="small muted">Summary</div>
              <div style="font-weight:800;font-size:18px;margin-top:8px;" id="summary-name">—</div>
              <div class="small muted" id="summary-sku">SKU —</div>
              <div style="margin-top:10px;font-weight:800;color:var(--accent);" id="summary-price">₨0</div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px;">
              <button class="btn" id="btn-paid">I've paid — Upload screenshot</button>
              <button class="btn-ghost" id="btn-cancel">Cancel order</button>
            </div>

            <div class="note small muted">
              Tip: Keep payment screenshot/transaction ID for faster verification. You will be able to upload it in the next step.
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Footer placeholder for dynamic injection -->
    <div id="footer-container"></div>
  </div>

  <script>
    /**
     * Payment page logic
     * - Reads product from localStorage 'apex_selected_product'
     * - Generates a pending order and stores it in localStorage under 'apex_pending_order'
     * - Provides QR visuals (SVG data URLs) for eSewa (ID: 9767438638) and Khalti (demo)
     * - Provides Copy and Open actions for wallets
     * - Upload actions navigate to upload.html where user attaches screenshot and finalizes order
     *
     * Notes:
     * - No real payment verification is performed in this client-only demo.
     * - The eSewa ID requested (9767438638) is displayed clearly to the user.
     */

    (function(){
      // Helper functions
      function qs(sel){ return document.querySelector(sel); }
      function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
      function formatCurrency(n){ return '₨' + Number(n || 0).toLocaleString(); }
      function nowPlusMinutes(m){ return new Date(Date.now() + (m*60000)); }

      // Load footer dynamically (graceful fallback)
      (async function loadFooter(){
        const container = document.getElementById('footer-container');
        try{
          const res = await fetch('footer.html', {cache: "no-store"});
          if(!res.ok) throw new Error('No footer');
          container.innerHTML = await res.text();
        } catch (e){
          container.innerHTML = `<div style="font-size:12px;color:rgba(255,255,255,0.6);text-align:center;padding-top:6px;">
            © 2026 Apex Nepal Pvt Ltd | All rights reserved
          </div>`;
        }
      })();

      // Read selected product from localStorage
      const raw = localStorage.getItem('apex_selected_product');
      let product = null;
      try { product = raw ? JSON.parse(raw) : null; } catch(e){ product = null; }

      if(!product){
        // If no product selected, go back to store
        alert('No product selected. Redirecting to store.');
        setTimeout(() => { window.location.href = 'store.html'; }, 200);
        return;
      }

      // Build pending order object
      const orderId = 'ORD' + Date.now() + Math.floor(Math.random()*9000+1000);
      const pendingOrder = {
        id: orderId,
        username: localStorage.getItem('apex_current_user') || 'guest',
        productId: product.id || null,
        productName: product.name || '',
        price: Number(product.price || 0),
        currency: product.currency || 'NPR',
        status: 'waiting_for_payment',
        paymentMethod: 'eSewa',
        paymentAccount: '9767438638', // real ID as requested
        createdAt: new Date().toISOString(),
        expireAt: nowPlusMinutes(20).toISOString(),
        screenshot: null // saved later on upload
      };

      // Persist temporary pending order
      localStorage.setItem('apex_pending_order', JSON.stringify(pendingOrder));

      // Render product info
      qs('#product-name').textContent = product.name || 'Top-up';
      qs('#product-price').textContent = formatCurrency(product.price || 0);
      qs('#summary-name').textContent = product.name || 'Top-up';
      qs('#summary-sku').textContent = (product.sku ? product.sku + ' • ' : '') + (product.category || '');
      qs('#summary-price').textContent = formatCurrency(product.price || 0);
      qs('#order-id').textContent = orderId;
      const exp = new Date(pendingOrder.expireAt);
      qs('#expiry').textContent = exp.toLocaleString();

      // Utility: create simple QR-like SVG for demo
      function makeQRSVG(text, size = 260, label = ''){
        // This is a stylized placeholder QR that includes the text; it's not a machine-readable QR.
        // In a production environment you'd use a real QR image from the payment provider.
        const s = size;
        const pad = 12;
        const bg = '#fff';
        const fg = '#000';
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${s}' height='${s}' viewBox='0 0 ${s} ${s}'>
          <rect width='100%' height='100%' fill='${bg}' rx='12' />
          <g fill='${fg}'>
            <!-- decorative blocks -->
            <rect x='${pad}' y='${pad}' width='36' height='36' />
            <rect x='${s-pad-36}' y='${pad}' width='36' height='36' />
            <rect x='${pad}' y='${s-pad-36}' width='36' height='36' />
            <!-- center pattern -->
            <rect x='${Math.floor(s*0.35)}' y='${Math.floor(s*0.22)}' width='24' height='24' />
            <rect x='${Math.floor(s*0.58)}' y='${Math.floor(s*0.45)}' width='18' height='18' />
            <rect x='${Math.floor(s*0.28)}' y='${Math.floor(s*0.62)}' width='20' height='20' />
          </g>
          <text x='50%' y='${s - 18}' font-size='12' text-anchor='middle' fill='#333' font-family='Arial'>${label}</text>
          <text x='50%' y='${s - 4}' font-size='11' text-anchor='middle' fill='#666' font-family='Arial'>${text}</text>
        </svg>`;
        return 'data:image/svg+xml;base64,' + btoa(svg);
      }

      // Insert QR images (SVG data URLs) into containers
      const esewaContainer = qs('#esewa-qr');
      const khaltiContainer = qs('#khalti-qr');
      const esewaId = '9767438638';
      const khaltiDemo = 'KHALTI-DEMO-001';

      esewaContainer.innerHTML = `<img alt="eSewa QR (ID: ${esewaId})" src="${makeQRSVG('eSewa:' + esewaId, 260, 'eSewa QR')}" />`;
      khaltiContainer.innerHTML = `<img alt="Khalti QR demo" src="${makeQRSVG('Khalti:' + khaltiDemo, 240, 'Khalti QR')}" />`;

      // Copy / Open handlers
      qs('#copy-esewa').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(esewaId);
          qs('#copy-esewa').textContent = 'Copied';
          setTimeout(()=> qs('#copy-esewa').textContent = 'Copy', 1400);
        } catch(e){
          alert('Copy failed. eSewa ID: ' + esewaId);
        }
      });

      qs('#open-esewa').addEventListener('click', () => {
        // Attempt to open eSewa app via a deeplink (demo). Fallback to a help page.
        // Real deeplink formats vary; this is a safe placeholder.
        window.open('https://esewa.com.np/#/login', '_blank');
      });

      qs('#copy-khalti').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(khaltiDemo);
          qs('#copy-khalti').textContent = 'Copied';
          setTimeout(()=> qs('#copy-khalti').textContent = 'Copy', 1400);
        } catch(e){
          alert('Copy failed. Khalti ID: ' + khaltiDemo);
        }
      });
      qs('#open-khalti').addEventListener('click', () => {
        window.open('https://khalti.com/', '_blank');
      });

      // Navigation buttons
      qs('#btn-back').addEventListener('click', () => { window.location.href = 'store.html'; });
      qs('#btn-cancel').addEventListener('click', () => {
        if(confirm('Cancel this pending order?')) {
          localStorage.removeItem('apex_pending_order');
          window.location.href = 'store.html';
        }
      });

      // Primary action: I've paid -> go to upload screen to attach proof
      function gotoUpload(){
        // ensure pending order is saved to apex_pending_order (already saved), then navigate
        localStorage.setItem('apex_pending_order', JSON.stringify(pendingOrder));
        // Also create or update a lightweight apex_orders list with a pending entry for UI continuity
        try {
          const all = JSON.parse(localStorage.getItem('apex_orders') || '[]');
          // Remove any existing entry with same id (defensive)
          const filtered = all.filter(o => o.id !== pendingOrder.id);
          filtered.push(pendingOrder);
          localStorage.setItem('apex_orders', JSON.stringify(filtered));
        } catch(e){}
        // Navigate to upload page where user will attach screenshot and finalize
        window.location.href = 'upload.html';
      }

      qs('#btn-upload').addEventListener('click', gotoUpload);
      qs('#btn-paid').addEventListener('click', gotoUpload);

      // Keep pending order up-to-date (in case product data is changed)
      localStorage.setItem('apex_pending_order', JSON.stringify(Object.assign({}, pendingOrder, {
        lastUpdatedAt: new Date().toISOString()
      })));

      // Listen for storage sync updates (in case of multi-tab)
      window.addEventListener('storage', (ev) => {
        if(ev.key === 'apex_selected_product'){
          // update product details if changed
          try {
            const p = JSON.parse(ev.newValue);
            if(p){
              product = p;
              qs('#product-name').textContent = product.name || 'Top-up';
              qs('#product-price').textContent = formatCurrency(product.price || 0);
              qs('#summary-name').textContent = product.name || 'Top-up';
              qs('#summary-price').textContent = formatCurrency(product.price || 0);
            }
          } catch(e){}
        }
      });

    })();
  </script>

  <!-- Global app behaviours and utilities -->
  <script src="app.js" defer></script>
</body>
</html>
